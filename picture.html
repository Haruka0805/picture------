<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å†™çœŸã‚®ãƒ£ãƒ©ãƒªãƒ¼</title>

  <!-- ã‚ãªãŸã®CSS -->
  <link rel="stylesheet" href="picture.css" />

  <!-- Lightbox2 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.5/css/lightbox.css"
    integrity="sha512-DKdRaC0QGJ/kjx0U0TtJNCamKnN4l+wsMdION3GG0WVK6hIoJ1UPHRHeXNiGsXdrmq19JJxgIubb/Z7Og2qJww=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
  <header class="site-header">
    <h1>ã‚ã¿ã‚‚ã®è¨˜éŒ²</h1>
    <div class="controls">
      <input id="search" type="search" placeholder="ä½œå“åãƒ»ã‚¿ã‚°ã§æ¤œç´¢" aria-label="æ¤œç´¢" />
      <button id="addBtn" class="btn">ï¼‹ ä½œå“ã‚’è¿½åŠ </button>
      <button id="exportBtn" class="btn">JSONã‚’æ›¸ãå‡ºã—</button>
      <button id="clearBtn" class="btn btn--ghost" title="ã“ã®ç«¯æœ«ã®ä¸€æ™‚ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤">ç«¯æœ«ã®ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿æ¶ˆå»</button>
      <span id="count" class="muted"></span>
    </div>
  </header>

  <main>
    <div class="gallery" id="grid" aria-live="polite"></div>
    <p id="emptyState" class="empty" hidden>ğŸ«– ä¸€è‡´ã™ã‚‹ä½œå“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ¤œç´¢èªã‚’çŸ­ãã™ã‚‹ã‹ã€ã‚¿ã‚°ã‚’å¤‰ãˆã¦ã¿ã¦ã­ã€‚</p>
  </main>

  <button id="toTop" aria-label="ãƒˆãƒƒãƒ—ã¸">â¬†ï¸</button>

  <!-- jQuery & Lightbox2 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
    integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.5/js/lightbox.min.js"
    integrity="sha512-KbRFbjA5bwNan6DvPl1ODUolvTTZ/vckssnFhka5cG80JVa5zSlRPCr055xSgU/q6oMIGhZWLhcbgIC0fyw3RQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- ä½œå“ãƒ‡ãƒ¼ã‚¿ï¼ˆGitHubå…¬é–‹ç”¨ã®å…ƒãƒ‡ãƒ¼ã‚¿ï¼‰-->
  <script src="works.js"></script>

  <!-- ã‚¢ãƒ—ãƒªæœ¬ä½“ -->
  <script>
  ;(() => {
    const saveKey = 'knit-works';         // localStorage ã‚­ãƒ¼
    const grid = document.getElementById('grid');
    const search = document.getElementById('search');
    const emptyState = document.getElementById('emptyState');
    const count = document.getElementById('count');

    // 1) ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼šworks.js â†’ ç«¯æœ«ä¿å­˜ï¼ˆã‚ã‚Œã°ä¸Šæ›¸ãï¼‰
    /** @type {{id?:string,title:string,date?:string,yarn?:string,needle?:string,hours?:number,tags?:string[],img:string,alt?:string}[]} */
    let works = Array.isArray(window.WORKS) ? structuredClone(window.WORKS) : [];
    ensureIds(works);

    const saved = localStorage.getItem(saveKey);
    if (saved) {
      try {
        const local = JSON.parse(saved);
        if (Array.isArray(local)) {
          // ç«¯æœ«ä¿å­˜ãŒå„ªå…ˆï¼ˆç·¨é›†ä¸­ã®æœ€æ–°çŠ¶æ…‹ï¼‰
          works = local;
          ensureIds(works);
        }
      } catch (_) {}
    }

    // 2) ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function render(list = works) {
      const query = search.value.trim().toLowerCase();
      const filtered = list.filter(w => {
        if (!query) return true;
        const hay = [
          w.title, w.date, w.yarn, w.needle,
          (w.hours ?? '') + '',
          (w.tags || []).join(' ')
        ].join(' ').toLowerCase();
        return hay.includes(query);
      });

      grid.innerHTML = filtered.map(w => `
        <figure class="card" id="${w.id}" data-tags="${(w.tags||[]).join(' ')}">
          <a href="${w.img}" data-lightbox="knit"
             data-title="${escapeHtml(`${w.title || ''}ï½œ${w.date || ''}ï½œç³¸:${w.yarn || ''}ï½œé‡:${w.needle || ''}ï½œ${w.hours ?? '-'}h`)}">
            <img class="thumb"
                 src="${w.img}"
                 alt="${escapeHtml(w.alt || w.title || '')}"
                 loading="lazy" decoding="async" />
          </a>
          <figcaption class="cap">
            <b class="ttl">${escapeHtml(w.title || '')}</b>
            <span class="meta">
              ${w.date ? `ğŸ“… ${escapeHtml(w.date)} / ` : ''}
              â±ï¸ ${w.hours ?? '-'}h
              ${w.tags?.length ? ' / ' + w.tags.slice(0, 3).map(t => `#${escapeHtml(t)}`).join(' ') : ''}
            </span>
          </figcaption>
        </figure>
      `).join('');

      emptyState.hidden = filtered.length > 0;
      count.textContent = `${filtered.length} / ${works.length} ä»¶`;
      // Lightboxå†åˆæœŸåŒ–ï¼ˆæ–°è¦è¦ç´ ã«ã‚‚åŠ¹ã‹ã›ã‚‹ï¼‰
      if (window.lightbox?.init) lightbox.init();
    }

    // 3) æ¤œç´¢ã‚¤ãƒ™ãƒ³ãƒˆ
    search.addEventListener('input', () => {
      render();
      saveState();
    });

    // 4) ä½œå“è¿½åŠ ï¼ˆprompt + ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠï¼‰
    document.getElementById('addBtn').addEventListener('click', async () => {
      const title = prompt('ä½œå“åï¼ˆä¾‹ï¼šçŒ«è€³å¸½å­ï¼‰');
      if (!title) return;

      const date = prompt('æ—¥ä»˜ï¼ˆYYYY-MM-DDï¼‰', new Date().toISOString().slice(0,10)) || '';
      const yarn = prompt('ç³¸ï¼ˆä¾‹ï¼šã‚³ãƒƒãƒˆãƒ³ä¸¦å¤ªã€ä»»æ„ï¼‰') || '';
      const needle = prompt('é‡ï¼ˆä¾‹ï¼š4å·ã€ä»»æ„ï¼‰') || '';
      const hours = parseFloat(prompt('æ‰€è¦æ™‚é–“ï¼ˆhã€ä»»æ„ï¼‰') || '') || '';
      const tags = (prompt('ã‚¿ã‚°ï¼ˆã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã€ä»»æ„ï¼‰') || '').split(/\s+/).filter(Boolean);

      const input = Object.assign(document.createElement('input'), { type: 'file', accept: 'image/*' });
      input.click();
      input.onchange = async () => {
        const file = input.files?.[0];
        if (!file) return;
        const dataUrl = await fileToDataURL(file); // ç«¯æœ«å†…ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ï¼ˆå…¬é–‹å‰ã¯å·®ã—æ›¿ãˆã‚‹ï¼‰
        const id = 'w_' + Math.random().toString(36).slice(2, 9);

        const item = { id, title, date, yarn, needle, hours, tags, img: dataUrl, alt: title };
        works.unshift(item);
        saveState();
        render();

        alert('è¿½åŠ ã—ã¾ã—ãŸï¼\nâ€»ã“ã®ç«¯æœ«å†…ã«ä¿å­˜ã—ã¾ã—ãŸï¼ˆå…¬é–‹ç‰ˆã«ã¯æœªåæ˜ ï¼‰\nå…¬é–‹ã™ã‚‹ã«ã¯ã€ŒJSONã‚’æ›¸ãå‡ºã—ã€ã§works.jsã‚’å‡ºåŠ›ã—ã€ç”»åƒã‚’images/ã«ã‚¢ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚');
        // ãƒˆãƒƒãƒ—ã¸æˆ»ã™ï¼ˆæ–°è¦ãŒå…ˆé ­ã«æ¥ã‚‹ãŸã‚ï¼‰
        window.scrollTo({ top: 0, behavior: 'smooth' });
      };
    });

    // 5) JSONæ›¸ãå‡ºã—ï¼ˆDataURL â†’ ãƒ•ã‚¡ã‚¤ãƒ«åã«ç½®æ›ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼‰
    document.getElementById('exportBtn').addEventListener('click', () => {
      // ä¾‹: images/neko-mimi-2025-10-10-1.jpg ã®ã‚ˆã†ã«å‘½å
      const exported = works.map((w, i) => {
        const base = slugify((w.title || 'work') + '-' + (w.date || 'xxxx-xx-xx'));
        const fname = `${base}-${String(i + 1).padStart(2, '0')}.jpg`;
        const img = w.img?.startsWith?.('data:') ? `images/${fname}` : w.img;
        return { ...w, img };
      });

      // window.WORKS=â€¦ å½¢å¼ã§ä¿å­˜ï¼ˆãã®ã¾ã¾ works.js ã¨ã—ã¦ç½®ã‘ã‚‹ï¼‰
      const text = `window.WORKS=${JSON.stringify(exported, null, 2)};`;
      const blob = new Blob([text], { type: 'application/javascript' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'works.js';
      a.click();
      URL.revokeObjectURL(a.href);

      alert('works.js ã‚’æ›¸ãå‡ºã—ã¾ã—ãŸï¼\n1) ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ images/ ã«ã‚¢ãƒƒãƒ—\n2) ã“ã® works.js ã‚’ãƒªãƒã‚¸ãƒˆãƒªã«ä¸Šæ›¸ã\nâ†’ GitHub Pages ã«åæ˜ ã•ã‚Œã¾ã™ã€‚');
    });

    // 6) ç«¯æœ«ã®ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ï¼ˆã‚„ã‚Šç›´ã—ãŸã„æ™‚ï¼‰
    document.getElementById('clearBtn').addEventListener('click', () => {
      const ok = confirm('ã“ã®ç«¯æœ«ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ä»®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚å…¬é–‹æ¸ˆã¿ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆworks.jsï¼‰ã¯æ¶ˆãˆã¾ã›ã‚“ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ');
      if (!ok) return;
      localStorage.removeItem(saveKey);
      // å…¬é–‹ç‰ˆï¼ˆworks.jsï¼‰ã‚’å†èª­è¾¼
      works = Array.isArray(window.WORKS) ? structuredClone(window.WORKS) : [];
      ensureIds(works);
      search.value = '';
      render();
      alert('ç«¯æœ«ã®ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã—ãŸã€‚');
    });

    // ä¿å­˜ãƒ»å¾©å…ƒ
    function saveState() {
      localStorage.setItem(saveKey, JSON.stringify(works));
    }

    // Helpers
    function ensureIds(arr) {
      arr.forEach(w => { if (!w.id) w.id = 'w_' + Math.random().toString(36).slice(2, 9); });
    }
    function fileToDataURL(file) {
      return new Promise(res => {
        const r = new FileReader();
        r.onload = () => res(r.result);
        r.readAsDataURL(file);
      });
    }
    function slugify(s) {
      return String(s).toLowerCase()
        .normalize('NFKD').replace(/[\u0300-\u036f]/g, '')  // æ¿ç‚¹ãƒ»ã‚¢ã‚¯ã‚»ãƒ³ãƒˆé™¤å»
        .replace(/[^\w\-]+/g, '-')                          // éå˜èªâ†’ãƒã‚¤ãƒ•ãƒ³
        .replace(/-{2,}/g, '-').replace(/^-+|-+$/g, '');
    }
    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // ãƒˆãƒƒãƒ—ã¸ãƒœã‚¿ãƒ³
    const toTop = document.getElementById('toTop');
    toTop.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

    // åˆæœŸæç”»
    lightbox.option({ fadeDuration: 200, resizeDuration: 200, wrapAround: true, albumLabel: "%1 / %2" });
    render();
  })();
  </script>
</body>
</html>